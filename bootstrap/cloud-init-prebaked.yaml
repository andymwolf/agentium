#cloud-config
# Agentium Streamlined Cloud-Init (for pre-baked images)
#
# This cloud-init script is used with pre-baked machine images that already
# have all tools installed (Docker, Node.js, Claude Code, gh, gcloud).
# It only handles runtime configuration: starting services and launching
# the session based on instance metadata.
#
# For full provisioning (stock Ubuntu), see cloud-init.yaml instead.

runcmd:
  # Start Docker (already installed in image)
  - systemctl start docker

  # Ensure workspace directory exists and has correct ownership
  - mkdir -p /workspace
  - chown agentium:agentium /workspace

  # Log startup
  - echo "Agentium pre-baked image startup at $(date)" >> /var/log/agentium-init.log

  # Read session config from instance metadata and start session
  - |
    # Helper function to fetch metadata with retry
    fetch_metadata() {
      local key="$1"
      local max_attempts=10
      local attempt=1
      while [ $attempt -le $max_attempts ]; do
        value=$(curl -sf -H "Metadata-Flavor: Google" \
          "http://metadata.google.internal/computeMetadata/v1/instance/attributes/${key}" 2>/dev/null)
        if [ -n "$value" ]; then
          echo "$value"
          return 0
        fi
        sleep 2
        attempt=$((attempt + 1))
      done
      return 1
    }

    # Check if we should auto-start a session
    if fetch_metadata "agentium-autostart" > /dev/null 2>&1; then
      echo "Auto-start enabled, fetching session config..." >> /var/log/agentium-init.log

      # Export session config from metadata
      export AGENTIUM_SESSION_ID=$(fetch_metadata "agentium-session-id")
      export AGENTIUM_REPOSITORY=$(fetch_metadata "agentium-repository")
      export AGENTIUM_ISSUES=$(fetch_metadata "agentium-issues")
      export GITHUB_APP_ID=$(fetch_metadata "github-app-id")
      export GITHUB_INSTALLATION_ID=$(fetch_metadata "github-installation-id")
      export GITHUB_PRIVATE_KEY_SECRET=$(fetch_metadata "github-private-key-secret")
      export ANTHROPIC_API_KEY_SECRET=$(fetch_metadata "anthropic-api-key-secret")

      # Fetch PR metadata (optional, for PR review sessions)
      export AGENTIUM_PRS=$(fetch_metadata "agentium-prs" 2>/dev/null || echo "")

      # Validate required metadata - need repository and at least issues or PRs
      if [ -z "$AGENTIUM_REPOSITORY" ]; then
        echo "ERROR: Missing required metadata (repository)" >> /var/log/agentium-init.log
        exit 1
      fi
      if [ -z "$AGENTIUM_ISSUES" ] && [ -z "$AGENTIUM_PRS" ]; then
        echo "ERROR: Missing required metadata (at least issues or prs required)" >> /var/log/agentium-init.log
        exit 1
      fi

      # Fetch Anthropic API key from Secret Manager if configured
      if [ -n "$ANTHROPIC_API_KEY_SECRET" ]; then
        # Ensure gcloud is in PATH
        if [ -f /opt/google-cloud-sdk/path.bash.inc ]; then
          source /opt/google-cloud-sdk/path.bash.inc
        fi
        export ANTHROPIC_API_KEY=$(gcloud secrets versions access latest --secret="$ANTHROPIC_API_KEY_SECRET")
      fi

      # Mark as ready
      touch /var/run/agentium-ready

      # Run the session as the agentium user (non-root)
      sudo -u agentium \
        HOME="/home/agentium" \
        AGENTIUM_SESSION_ID="$AGENTIUM_SESSION_ID" \
        AGENTIUM_REPOSITORY="$AGENTIUM_REPOSITORY" \
        AGENTIUM_ISSUES="${AGENTIUM_ISSUES:-}" \
        AGENTIUM_PRS="${AGENTIUM_PRS:-}" \
        GITHUB_APP_ID="$GITHUB_APP_ID" \
        GITHUB_INSTALLATION_ID="$GITHUB_INSTALLATION_ID" \
        GITHUB_PRIVATE_KEY_SECRET="$GITHUB_PRIVATE_KEY_SECRET" \
        ANTHROPIC_API_KEY="${ANTHROPIC_API_KEY:-}" \
        /usr/local/bin/agentium-session 2>&1 | tee /var/log/agentium-session.log
    fi

final_message: |
  Agentium pre-baked image ready!
  Image info: $(cat /etc/agentium-image 2>/dev/null || echo "unknown")
